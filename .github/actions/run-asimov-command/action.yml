name: 'Run Asimov Command'
description: 'Execute asimov command as submituser'
inputs:
  command:
    description: 'Asimov command to run (without asimov prefix)'
    required: true
  working-directory:
    description: 'Working directory relative to GITHUB_WORKSPACE'
    default: 'test_project'
    required: false
  extra-env:
    description: 'Additional environment variables (e.g., "VAR1=value1 VAR2=value2")'
    default: ''
    required: false
  shell-setup:
    description: 'Additional shell setup commands to run before asimov command'
    default: ''
    required: false
runs:
  using: "composite"
  steps:
    - name: Run asimov command
      shell: bash
      run: |
        # Find conda executable - look in common locations
        if [ -n "${CONDA_EXE:-}" ] && [ -x "$CONDA_EXE" ]; then
          CONDA_BIN="$CONDA_EXE"
        elif [ -n "${CONDA:-}" ] && [ -x "${CONDA}/bin/conda" ]; then
          CONDA_BIN="${CONDA}/bin/conda"
        elif [ -x "/usr/share/miniconda/bin/conda" ]; then
          CONDA_BIN="/usr/share/miniconda/bin/conda"
        elif [ -x "/opt/miniconda3/bin/conda" ]; then
          CONDA_BIN="/opt/miniconda3/bin/conda"
        else
          # Try to find conda in PATH
          CONDA_BIN=$(which conda 2>/dev/null || echo "/usr/share/miniconda/bin/conda")
        fi
        
        if [ ! -x "$CONDA_BIN" ]; then
          echo "Conda not found at: $CONDA_BIN" >&2
          exit 1
        fi
        
        echo "Using conda at: $CONDA_BIN"
        
        # Export for use in su
        export CONDA_BIN
        export GITHUB_WORKSPACE
        
        # Build the command to run
        WORKDIR="${{ inputs.working-directory }}"
        EXTRA_ENV=$(cat <<'ENV_EOF'
        ${{ inputs.extra-env }}
        ENV_EOF
        )
        SHELL_SETUP=$(cat <<'SETUP_EOF'
        ${{ inputs.shell-setup }}
        SETUP_EOF
        )
        COMMAND=$(cat <<'CMD_EOF'
        ${{ inputs.command }}
        CMD_EOF
        )
        
        # Export for submituser
        export WORKDIR EXTRA_ENV SHELL_SETUP COMMAND
        
        # Run as submituser
        su - submituser -c 'cd "$GITHUB_WORKSPACE/$WORKDIR" && eval "$EXTRA_ENV" && eval "$SHELL_SETUP" && $CONDA_BIN run -n asimov asimov '"$COMMAND"
