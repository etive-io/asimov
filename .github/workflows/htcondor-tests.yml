name: Tests with HTCondor
on: [push, pull_request]

jobs:
  tests:
    name: "HTCondor Testing"
    runs-on: ubuntu-latest
    container:
      image: htcondor/mini:latest
      options: --privileged
    defaults:
      run:
        shell: bash -el {0}
    steps:

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-htcondor

      - name: Install base tools
        run: |
          yum install -y sudo git

      - uses: ./.github/actions/create-submit-user

      - uses: ./.github/actions/setup-asimov-env
        with:
          python-version: "3.10"
          extra-packages: "-U bilby bilby_pipe git+https://git.ligo.org/asimov/pipelines/gwdata.git@update-htcondor"

      - name: Create asimov project
        uses: ./.github/actions/run-asimov-command
        with:
          command: init "Test Project"
          working-directory: test_project
          shell-setup: |
            mkdir -p test_project
            cd test_project
            git config --global init.defaultBranch master
            git config --global user.email "you@example.com"
            git config --global user.name "Your Name"

      - name: Configure asimov project
        uses: ./.github/actions/run-asimov-command
        with:
          command: |
            configuration update condor/user submituser
            asimov configuration update condor/cache_time 30
            asimov configuration update condor/cron_minute '*/1'
            asimov apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_quick_test.yaml"
          working-directory: test_project

      - name: Test Event Add
        uses: ./.github/actions/run-asimov-command
        with:
          command: apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_event.yaml"
          working-directory: test_project

      - name: Test GWData
        env:
          GWDATAFIND_SERVER: https://datafind.gwosc.org
        uses: ./.github/actions/run-asimov-command
        with:
          command: |
            apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_get_data.yaml" -e GW150914_095045
            asimov manage build
            asimov manage submit
          working-directory: test_project

      - name: Wait for GWData frame files
        uses: ./.github/actions/wait-for-files
        with:
          patterns: "H*.gwf L*.gwf"
          directory: "working/GW150914_095045/get-data/frames"
          timeout: "600"
          interval: "30"
          working-directory: test_project

      - name: Monitor GWData
        uses: ./.github/actions/run-asimov-command
        with:
          command: monitor
          working-directory: test_project

      - name: Test Bayeswave
        env:
          GWDATAFIND_SERVER: https://datafind.gwosc.org
        uses: ./.github/actions/run-asimov-command
        with:
          command: |
            apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/bayeswave_quick_test.yaml" -e GW150914_095045
            asimov manage build
            asimov manage submit
          working-directory: test_project

      - name: Wait for Bayeswave PSD files
        uses: ./.github/actions/wait-for-files
        with:
          patterns: "trigtime_*/post/clean/glitch_median_PSD_forLI_H1.dat trigtime_*/post/clean/glitch_median_PSD_forLI_L1.dat"
          directory: "working/GW150914_095045/generate-psd"
          timeout: "600"
          interval: "30"
          working-directory: test_project

      - name: Clean up Bayeswave and monitor
        uses: ./.github/actions/run-asimov-command
        with:
          command: monitor
          working-directory: test_project
          shell-setup: |
            condor_rm 2
            rm .asimov/_cache_jobs.yaml

      - name: Test Bilby
        env:
          GWDATAFIND_SERVER: https://datafind.gwosc.org
        uses: ./.github/actions/run-asimov-command
        with:
          command: |
            apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/bilby_quick_test.yaml" -e GW150914_095045
            asimov manage build
            asimov manage submit
          working-directory: test_project

      - name: Wait for Bilby result files
        uses: ./.github/actions/wait-for-files
        with:
          patterns: "final_result/*.hdf5"
          directory: "working/GW150914_095045/bilby-IMRPhenomXPHM"
          timeout: "2400"
          interval: "30"
          working-directory: test_project

      - name: Monitor Bilby
        uses: ./.github/actions/run-asimov-command
        with:
          command: monitor
          working-directory: test_project