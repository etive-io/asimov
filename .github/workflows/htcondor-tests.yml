name: Tests with HTCondor
on: [push, pull_request]

jobs:
  tests:
    name: "HTCondor Testing"
    runs-on: ubuntu-latest
    container: 
      image: htcondor/mini:latest
      options: --privileged
    defaults:
      run:
        shell: bash -el {0}
    steps:

      
      - name: Start HTCondor
        run: |
          condor_master &
          sleep 10
          condor_status

      - name: Install base tools
        run: |
          yum install -y sudo git

      - name: Create submit user
        run: |
          # Create a passwordless sudo user for running Condor jobs
          id -u submituser >/dev/null 2>&1 || useradd -m -s /bin/bash submituser

              su - submituser <<EOF
              set -euo pipefail
              cd "$GITHUB_WORKSPACE/test_project"

              $ASIMOV_CMD asimov apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_get_data.yaml" -e GW150914_095045
              $ASIMOV_CMD asimov manage build

              $ASIMOV_CMD asimov manage submit

              # Watch for frame files to appear
              echo 'Waiting for H1.gwf and L1.gwf frame files to appear...'
              TIMEOUT=600
              ELAPSED=0
              INTERVAL=30
          
              while [ \$ELAPSED -lt \$TIMEOUT ]; do
                condor_q
            
                if [ -f working/GW150914_095045/get-data/frames/H1.gwf ] && [ -f working/GW150914_095045/get-data/frames/L1.gwf ]; then
                  echo 'Frame files H1.gwf and L1.gwf found!'
                  ls -lh working/GW150914_095045/get-data/frames/
                  break
                fi
            
                echo "Elapsed: \${ELAPSED}s / \${TIMEOUT}s - H1.gwf and/or L1.gwf not yet present, waiting..."
                sleep \$INTERVAL
                ELAPSED=\$((ELAPSED + INTERVAL))
              done
          
              if [ \$ELAPSED -ge \$TIMEOUT ]; then
                echo 'Timeout waiting for H1.gwf and L1.gwf frame files'
                ls -R working/GW150914_095045/ || true
              fi
          
              $ASIMOV_CMD asimov monitor
              EOF
        run: |
          CONDA_EXE="${CONDA_EXE:-${CONDA:-/usr/share/miniconda}/bin/conda}"
          if [ ! -x "$CONDA_EXE" ]; then
            echo "Conda not found at $CONDA_EXE" >&2
            exit 1
          fi
          ASIMOV_CMD="$CONDA_EXE run -n asimov"

          su - submituser -c "
          set -euo pipefail
          cd '$GITHUB_WORKSPACE'

          mkdir -p test_project
          cd test_project

          git config --global init.defaultBranch master
          git config --global user.email 'you@example.com'
          git config --global user.name 'Your Name'

          $ASIMOV_CMD asimov init 'Test Project'
          $ASIMOV_CMD asimov configuration update condor/user submituser
          $ASIMOV_CMD asimov configuration update condor/cache_time 30
          $ASIMOV_CMD asimov configuration update condor/cron_minute '*/1'
          $ASIMOV_CMD asimov apply -f '$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_quick_test.yaml'
          "

      - name: Test Event Add
        run: |
          CONDA_EXE="${CONDA_EXE:-${CONDA:-/usr/share/miniconda}/bin/conda}"
          if [ ! -x "$CONDA_EXE" ]; then
            echo "Conda not found at $CONDA_EXE" >&2
            exit 1
          fi
          ASIMOV_CMD="$CONDA_EXE run -n asimov"

          su - submituser -c "
          set -euo pipefail
          cd '$GITHUB_WORKSPACE/test_project'

          $ASIMOV_CMD asimov apply -f https://git.ligo.org/asimov/data/-/raw/gwosc/events/gwtc-2-1/GW150914_095045.yaml
          "

      - name: Test GWData
        env:
          GWDATAFIND_SERVER: https://datafind.gwosc.org
        run: |
          CONDA_EXE="${CONDA_EXE:-${CONDA:-/usr/share/miniconda}/bin/conda}"
          if [ ! -x "$CONDA_EXE" ]; then
            echo "Conda not found at $CONDA_EXE" >&2
            exit 1
          fi
          ASIMOV_CMD="$CONDA_EXE run -n asimov"

          su - submituser -c "
          set -euo pipefail
          cd '$GITHUB_WORKSPACE/test_project'

          $ASIMOV_CMD asimov apply -f '$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_get_data.yaml' -e GW150914_095045
          $ASIMOV_CMD asimov manage build

          $ASIMOV_CMD asimov manage submit

          # Watch for frame files to appear
          echo 'Waiting for H1.gwf and L1.gwf frame files to appear...'
          TIMEOUT=600
          ELAPSED=0
          INTERVAL=30
          
          while [ \$ELAPSED -lt \$TIMEOUT ]; do
            condor_q
            
            if [ -f working/GW150914_095045/get-data/frames/H1.gwf ] && [ -f working/GW150914_095045/get-data/frames/L1.gwf ]; then
              echo 'Frame files H1.gwf and L1.gwf found!'
              ls -lh working/GW150914_095045/get-data/frames/
              break
            fi
            
            echo \"Elapsed: \${ELAPSED}s / \${TIMEOUT}s - H1.gwf and/or L1.gwf not yet present, waiting...\"
            sleep \$INTERVAL
            ELAPSED=\$((ELAPSED + INTERVAL))
          done
          
          if [ \$ELAPSED -ge \$TIMEOUT ]; then
            echo 'Timeout waiting for H1.gwf and L1.gwf frame files'
            ls -R working/GW150914_095045/ || true
          fi
          
          $ASIMOV_CMD asimov monitor
        

      - name: Test Bayeswave
        env:
          GWDATAFIND_SERVER: https://datafind.gwosc.org
        run: |
          CONDA_EXE="${CONDA_EXE:-${CONDA:-/usr/share/miniconda}/bin/conda}"
          if [ ! -x "$CONDA_EXE" ]; then
            echo "Conda not found at $CONDA_EXE" >&2
            exit 1
          fi
          ASIMOV_CMD="$CONDA_EXE run -n asimov"

          su - submituser -c "
          set -euo pipefail
          cd '$GITHUB_WORKSPACE/test_project'

          $ASIMOV_CMD asimov apply -f '$GITHUB_WORKSPACE/tests/test_blueprints/bayeswave_quick_test.yaml' -e GW150914_095045
          $ASIMOV_CMD asimov manage build

          # $ASIMOV_CMD asimov manage submit

          /__w/asimov/asimov/3/envs/asimov/bin/bayeswave_pipe --trigger-time=1126259462.391 -r /__w/asimov/asimov/test_project/working/GW150914_095045/generate-psd /__w/asimov/asimov/test_project/checkouts/GW150914_095045/C01_offline/generate-psd.ini

          tail -n 100 asimov.log

          # sleep 60
          # condor_q 

          # sleep 300
          # ls working/GW150914_095045/generate-psd/* || true
          # $ASIMOV_CMD asimov monitor
          "

      # - name: Test Analysis get-data 
      #   run: |
      #     cd test_project
      #     conda run -n asimov asimov apply -f ../tests/test_blueprints/gwosc_get_data.yaml -e GW150914_095045
      #     conda run -n asimov asimov manage build
      #     conda run -n asimov asimov manage submit 
      #     sleep 300
      #     ls working/GW150914_095045/get-data/*
      #     asimov monitor