name: Tests with HTCondor
on: [push, pull_request]

jobs:
  tests:
    name: "HTCondor Testing"
    runs-on: ubuntu-latest
    container:
      image: htcondor/mini:latest
      options: --privileged
    defaults:
      run:
        shell: bash -el {0}
    steps:

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-htcondor

      - name: Install base tools
        run: |
          yum install -y sudo git

      - name: Create submit user
        uses: ./.github/actions/create-submit-user

      - name: Ensure submituser owns workspace
        run: |
          chown -R submituser:submituser "$GITHUB_WORKSPACE" || true
          mkdir -p "$GITHUB_WORKSPACE/test_project"
          chown -R submituser:submituser "$GITHUB_WORKSPACE/test_project" || chmod -R a+rwX "$GITHUB_WORKSPACE/test_project"

      - name: Setup Asimov Environment
        uses: ./.github/actions/setup-asimov-env
        with:
          python-version: "3.10"
          extra-packages: "-U bilby bilby_pipe git+https://git.ligo.org/asimov/pipelines/gwdata.git@update-htcondor"

      - name: Create asimov project
        uses: ./.github/actions/run-asimov-command
        with:
          command: asimov init "Test Project"
          working-directory: .
          shell-setup: |
            mkdir -p test_project
            cd test_project
            git config --global init.defaultBranch master
            git config --global user.email "you@example.com"
            git config --global user.name "Your Name"

      - name: Configure asimov project
        uses: ./.github/actions/run-asimov-command
        with:
          command: |
            asimov configuration update condor/user submituser
            asimov configuration update condor/cache_time 30
            asimov configuration update condor/cron_minute '*/1'
            asimov apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_quick_test.yaml"
          working-directory: test_project

      - name: Add event from GWOSC
        uses: ./.github/actions/run-asimov-command
        with:
          command: asimov apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_event.yaml"
          working-directory: test_project

      - name: Submit asimov-gwdata job
        env:
          GWDATAFIND_SERVER: https://datafind.gwosc.org
        uses: ./.github/actions/run-asimov-command
        with:
          command: |
            asimov apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_get_data.yaml" -e GW150914_095045
            asimov manage build
            asimov manage submit
          working-directory: test_project

      - name: Wait for frame files
        uses: ./.github/actions/wait-for-files
        with:
          patterns: "H*.gwf L*.gwf"
          directory: "working/GW150914_095045/get-data/frames"
          timeout: "600"
          interval: "30"
          working-directory: test_project

      - name: Run asimov monitor
        uses: ./.github/actions/run-asimov-command
        with:
          command: asimov monitor
          working-directory: test_project

      - name: Create PSDs using Bayeswave
        env:
          GWDATAFIND_SERVER: https://datafind.gwosc.org
        uses: ./.github/actions/run-asimov-command
        with:
          command: |
            asimov apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/bayeswave_quick_test.yaml" -e GW150914_095045
            asimov manage build
            asimov manage submit
          working-directory: test_project

      - name: Wait for PSD files
        uses: ./.github/actions/wait-for-files
        with:
          patterns: "trigtime_*/post/clean/glitch_median_PSD_forLI_H1.dat trigtime_*/post/clean/glitch_median_PSD_forLI_L1.dat"
          directory: "working/GW150914_095045/generate-psd"
          timeout: "600"
          interval: "30"
          working-directory: test_project

      - name: Clean up Bayeswave and monitor
        uses: ./.github/actions/run-asimov-command
        with:
          command: asimov monitor
          working-directory: test_project
          shell-setup: |
            condor_rm 2
            rm .asimov/_cache_jobs.yaml

      - name: Test Bilby
        env:
          GWDATAFIND_SERVER: https://datafind.gwosc.org
        uses: ./.github/actions/run-asimov-command
        with:
          command: |
            asimov apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/bilby_quick_test.yaml" -e GW150914_095045
            asimov manage build
            asimov manage submit
          working-directory: test_project

      - name: Wait for Bilby result files
        uses: ./.github/actions/wait-for-files
        with:
          patterns: "final_result/*.hdf5"
          directory: "working/GW150914_095045/bilby-IMRPhenomXPHM"
          timeout: "2400"
          interval: "30"
          working-directory: test_project

      - name: Monitor Bilby
        uses: ./.github/actions/run-asimov-command
        with:
          command: asimov monitor
          working-directory: test_project

      - name: Cleanup on exit
        if: always()
        uses: ./.github/actions/run-asimov-command
        with:
          command: condor_rm -all
          working-directory: test_project
          timeout: '60'