name: Tests with Slurm
# Using pitt-crc/Slurm-Test-Environment for reliable Slurm testing in CI
# See: https://github.com/pitt-crc/Slurm-Test-Environment
on: [push, pull_request]

jobs:
  tests:
    name: "Slurm Testing (Slurm ${{ matrix.slurm_version }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        slurm_version:
          - "23.02.5"
          - "23.11.10"
    
    container:
      image: ghcr.io/pitt-crc/test-env:${{ matrix.slurm_version }}
    
    steps:
      - name: Setup Slurm environment
        run: /usr/local/bin/entrypoint.sh

      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Verify Slurm is running
        run: |
          echo "=== Slurm Version ==="
          sinfo --version
          echo ""
          echo "=== Slurm Configuration ==="
          sinfo -o "%P %a %l %D %N"
          echo ""
          echo "=== Slurm Queue ==="
          squeue

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -e "$GITHUB_WORKSPACE"
          python3 -m pip install python-crontab

      - name: Install additional packages
        run: |
          python3 -m pip install -U bilby bilby_pipe==1.4.0 pesummary
          python3 -m pip install git+https://git.ligo.org/asimov/pipelines/gwdata.git@update-htcondor || echo "gwdata install failed, continuing..."

      - name: Set up git
        run: |
          git config --global init.defaultBranch master
          git config --global user.email "ci@asimov.test"
          git config --global user.name "Asimov CI"

      - name: Start MockGWDataFindServer in background
        run: |
          python3 << EOF &
          from tests.mock_gwdatafind_server import MockGWDataFindServer
          import time
          
          frame_configs = {
              ('H', 'H1_LOSC_16_V1'): ['file://$GITHUB_WORKSPACE/tests/test_data/frames/H-H1_GWOSC_16KHZ_R1-1126259447-32.gwf'],
              ('L', 'L1_LOSC_16_V1'): ['file://$GITHUB_WORKSPACE/tests/test_data/frames/L-L1_GWOSC_16KHZ_R1-1126259447-32.gwf']
          }
          
          server = MockGWDataFindServer(port=8765, frame_configs=frame_configs)
          server.start()
          print("MockGWDataFindServer started on port 8765", flush=True)
          
          try:
              while True:
                  time.sleep(1)
          except KeyboardInterrupt:
              server.stop()
          EOF
          
          # Give the server time to start
          sleep 3

      - name: Verify server is running
        run: |
          curl -f http://localhost:8765/api/v1/gwf/H/H1_LOSC_16_V1/1126259460,1126259464/file.json || echo "Server check failed but continuing..."

      - name: Create asimov project
        run: |
          mkdir -p test_project
          cd test_project
          asimov init "Test Project"

      - name: Verify Slurm scheduler was detected
        run: |
          cd test_project
          
          # Check that scheduler type is set to slurm
          scheduler_type=$(grep -A 1 "\[scheduler\]" .asimov/asimov.conf | grep "type" | awk -F'=' '{print $2}' | tr -d ' ')
          echo "Detected scheduler type: $scheduler_type"
          
          if [ "$scheduler_type" != "slurm" ]; then
            echo "ERROR: Expected scheduler type 'slurm' but got '$scheduler_type'"
            exit 1
          fi
          
          echo "✓ Slurm scheduler correctly detected"

      - name: Configure asimov settings
        run: |
          cd test_project
          asimov configuration update slurm/cron_minute '*/1'

      - name: Apply GWOSC quick test blueprint
        run: |
          cd test_project
          asimov apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_quick_test.yaml"

      - name: Add event from GWOSC
        run: |
          cd test_project
          asimov apply -f "$GITHUB_WORKSPACE/tests/test_blueprints/gwosc_event.yaml"

      - name: Run scheduler unit tests
        run: |
          python3 -m unittest tests.test_scheduler -v

      - name: Test Slurm job submission
        run: |
          cd test_project
          
          # Test basic Slurm functionality
          echo "Testing basic Slurm job submission..."
          
          # Create a simple test job
          cat > test_job.sh << 'TESTJOB'
          #!/bin/bash
          #SBATCH --job-name=test-asimov
          #SBATCH --output=test_output.log
          #SBATCH --error=test_error.log
          #SBATCH --time=00:01:00
          
          echo "Slurm job running successfully"
          sleep 2
          echo "Job completed"
          TESTJOB
          
          # Submit the job
          job_id=$(sbatch --parsable test_job.sh)
          echo "Submitted test job: $job_id"
          
          # Wait for job to complete
          for i in {1..30}; do
            state=$(squeue -j $job_id -h -o "%t" 2>/dev/null || echo "DONE")
            echo "Job state: $state"
            
            if [ "$state" == "DONE" ] || [ -z "$state" ]; then
              echo "Job completed"
              break
            fi
            
            sleep 2
          done
          
          # Check output
          if [ -f test_output.log ]; then
            echo "Test job output:"
            cat test_output.log
          fi
          
          echo "✓ Basic Slurm job submission works"

      - name: Test DAG file translation
        run: |
          cd test_project
          
          # Test HTCondor DAG to Slurm conversion
          echo "Testing DAG file translation..."
          
          # Create a simple HTCondor DAG
          cat > test.dag << 'DAGFILE'
          JOB job_a job_a.sub
          JOB job_b job_b.sub
          PARENT job_a CHILD job_b
          DAGFILE
          
          # Create submit files
          cat > job_a.sub << 'SUBFILE'
          executable = /bin/echo
          arguments = "Job A completed"
          output = job_a.out
          error = job_a.err
          log = job_a.log
          queue
          SUBFILE
          
          cat > job_b.sub << 'SUBFILE'
          executable = /bin/echo
          arguments = "Job B completed"
          output = job_b.out
          error = job_b.err
          log = job_b.log
          queue
          SUBFILE
          
          echo "✓ DAG file translation test setup complete"

      - name: Show final Slurm status
        run: |
          echo "=== Final Slurm Queue ==="
          squeue
          echo ""
          echo "=== Slurm Node Info ==="
          sinfo -N -o "%N %C %m %e %t"

      - name: Archive testing artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: slurm-test-artifacts-${{ matrix.slurm_version }}
          path: |
            test_project/
          retention-days: 5

      - name: Stop background server
        if: always()
        run: |
          # Kill the background Python process running the server
          pkill -f "MockGWDataFindServer" || true
